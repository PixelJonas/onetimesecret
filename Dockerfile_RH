# Based in ubi7/ubi-minimal:latest from registry.access.redhat.com
FROM registry.access.redhat.com/ubi7/ubi-minimal:latest

USER 0

# Dependencies
RUN microdnf --nodocs install \
    tar \
    gzip \
    bzip2 \
    openssl \
    curl \
    ruby \
    ruby-devel \
    rubygems \
    rubygem-bundler \
  && microdnf clean all \
  && gem install bundler

# OTS
RUN mkdir -p /var/log/onetime /var/run/onetime /var/lib/onetime /etc/onetime /opt/app-root/src
COPY . /opt/app-root/src
RUN cd /opt/app-root/src \
  && bundle install --frozen --deployment --without=dev \
  && gem update \
  && bin/ots init \
  && cp -R etc/* /etc/onetime

# Entrypoint
COPY entrypoint.sh /entrypoint.sh

# Permissions
RUN chown -R 0 /entrypoint.sh /var/log/onetime /var/run/onetime /var/lib/onetime /etc/onetime /opt/app-root/src \
  && chmod -R g=u /entrypoint.sh /var/log/onetime /var/run/onetime /var/lib/onetime /etc/onetime /opt/app-root/src \
  && chmod -R 770 /entrypoint.sh /opt/app-root/src/bin

EXPOSE 7143
USER 1001
WORKDIR /opt/app-root/src

ENTRYPOINT ["/entrypoint.sh"]
